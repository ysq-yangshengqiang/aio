# 流式AI聊天功能使用指南

本文档介绍如何在聊天助手中使用n8n webhook的流式响应功能。

## 功能概述

流式AI聊天功能允许用户在发送消息后实时看到AI的回复内容逐字显示，提供更加流畅和交互的聊天体验。

## 配置步骤

### 1. 快速配置您的Webhook

访问快速配置页面：`/chat/quick-setup`

或者点击聊天页面的"配置n8n"按钮。

#### 预设配置信息
- **Webhook URL**: `https://ysq123.app.n8n.cloud/webhook/66695751-ef1a-4f40-b901-b6fd7ca`
- **工作流类型**: 流式聊天 (chat_stream)
- **默认名称**: AI聊天助手 - 用户提供

### 2. 测试连接

在配置页面点击"测试连接"按钮，系统将：
- 发送测试请求到您的n8n webhook
- 验证连接是否正常
- 显示响应结果和状态信息

### 3. 激活工作流

配置完成后：
- 选中"立即激活此工作流"
- 点击"添加工作流"
- 系统会保存配置并激活该工作流

## 使用流式聊天

### 发送消息

1. 进入聊天页面 (`/chat`)
2. 在输入框中输入您的问题
3. 点击发送或按Enter键

### 流式显示效果

发送消息后，您会看到：

1. **状态指示器**: 显示AI调用的进度
   - 准备AI配置...
   - 正在调用n8n Webhook...
   - 处理AI响应...
   - 已连接到AI服务

2. **流式内容显示**: 
   - AI回复会逐字出现在聊天界面中
   - 光标指示器显示内容正在生成
   - 支持Markdown格式渲染

3. **完成指示**: 
   - 生成完成后光标消失
   - 显示响应元数据（模型、Token使用等）

## 界面特性

### 消息样式

- **用户消息**: 蓝紫渐变背景，右对齐
- **AI消息**: 白色背景，左对齐，支持Markdown
- **流式消息**: 带有闪烁光标和生成动画

### 交互功能

- **复制消息**: 点击消息上的复制按钮
- **重新生成**: 对AI回复不满意时重新生成
- **点赞/点踩**: 对AI回复进行评价
- **消息导出**: 导出整个聊天记录

## 技术实现

### 流式数据格式

系统支持标准的Server-Sent Events (SSE)格式：

```javascript
data: {"type": "connected", "data": {"message": "Stream connected"}}
data: {"type": "content", "data": "这是流式内容的一部分"}
data: {"type": "done", "data": {"content": "完整内容", "tokens_used": 150}}
```

### 支持的事件类型

- `connected`: 连接确认
- `content`: 流式内容块
- `done`: 流式完成
- `error`: 错误信息

## 故障排除

### 常见问题

1. **流式显示不工作**
   - 检查工作流类型是否设置为"流式聊天"
   - 确认n8n工作流支持流式输出
   - 查看浏览器开发者工具的网络请求

2. **连接超时**
   - 检查webhook URL是否正确
   - 确认n8n服务是否在线
   - 调整超时时间设置

3. **内容显示异常**
   - 检查n8n返回的数据格式
   - 确认SSE格式是否正确
   - 查看控制台错误信息

### 调试工具

使用提供的测试页面 (`n8n-stream-test.html`) 来：
- 测试webhook连接
- 查看原始响应数据
- 调试SSE流式数据

### 日志查看

系统会记录详细的调用日志：
- 请求时间和参数
- 响应状态和内容
- 错误信息和堆栈

## 高级配置

### 自定义工作流

如果需要自定义n8n工作流：

1. 访问工作流管理页面 (`/chat/workflow-manager`)
2. 创建新的工作流配置
3. 设置适当的超时时间和参数
4. 测试并激活工作流

### 多工作流支持

系统支持配置多个n8n工作流：
- 不同的AI模型和提供商
- 不同的用途和场景
- 可以随时切换激活状态

## 最佳实践

### 性能优化

- 使用适当的超时时间（建议30-60秒）
- 合理设置max_tokens参数
- 监控Token使用情况

### 用户体验

- 提供清晰的状态反馈
- 支持消息重试和编辑
- 实现平滑的动画效果

### 安全考虑

- 验证webhook URL的有效性
- 限制请求频率和并发
- 保护API密钥和凭据

## API参考

### 请求格式

发送到n8n webhook的请求格式：

```json
{
  "prompt": "用户输入的消息",
  "config": {
    "model_name": "gpt-3.5-turbo",
    "temperature": 0.7,
    "max_tokens": 1000,
    "stream": true
  },
  "context": {},
  "user_id": "用户ID",
  "session_id": "会话ID",
  "timestamp": "2024-01-01T00:00:00Z"
}
```

### 响应格式

期望的响应格式（非流式）：

```json
{
  "success": true,
  "response": "AI回复内容",
  "content": "AI回复内容",
  "tokens_used": 150,
  "model": "gpt-3.5-turbo",
  "execution_id": "n8n执行ID",
  "metadata": {
    "finish_reason": "stop",
    "response_time": 2500
  }
}
```

## 更新日志

### v1.0.0
- 初始版本，支持基本的流式聊天功能
- 集成n8n webhook调用
- 实现SSE流式数据处理

### v1.1.0
- 优化流式显示动画效果
- 添加详细的状态指示器
- 改进错误处理和回退机制

### v1.2.0
- 添加快速配置功能
- 创建独立的测试工具
- 完善用户界面和交互体验

## 支持

如果您在使用过程中遇到问题：

1. 查看本文档的故障排除部分
2. 使用测试工具验证配置
3. 查看浏览器控制台的错误信息
4. 检查n8n工作流的执行日志

## 相关资源

- [N8N工作流设置指南](./N8N_WORKFLOW_SETUP.md)
- [聊天系统架构文档](./CHAT_ARCHITECTURE.md)
- [API参考文档](./API_REFERENCE.md)